#Web安全攻击与防御

## 跨站脚本攻击XSS

#### 全称 (Corss Site Scipting)

+ 在参数中嵌入javascript脚本
+ 一般采用alert测试 如果弹出成功就代表当前站点存在跨站脚本攻击
+ 程序 + 数据 = 结果 
+ 反射性注入  直接通过url    相对危害较小  攻击者可以拿去生成一个短网址  https://www.985.so/
+ 存储性注入  存储到数据库并读取时
+ 注入点
  + 都是需要用户输入的内容
  + html节点内容
  + html属性
  + javascript代码
  + 富文本编辑器
    + 得保留html
    + html有xss攻击的风险
+ 解决方案
  + 需要进行数据的过滤  双引号  单引号 为实体  ;
  + 转义属性 空格 为实体  空格是为了防止不加引号的xss脚本
  + 以及数据的审核
  + 浏览器自带的防御  X-XSS-Protection,0关闭|1开启 默认
    + 只防范在html中注入的
  + 在防范富文本的时候可以使用cheerio这个库循环便利传递的dom结构树 是否在我们的白名单中
  + 还可以使用xss第三方库  更快捷 可以自定义  可以去看文档
  + **CSP 内容安全策略**
    + 是http的头
    + 可以设置不信任内容
    + 可以百度搜索设置方式
  + **PHP防御XSS**
    + 使用内置函数转义
    + 使用第三方库
    + CSP

## 跨站伪造请求CSRF  

#### 全称 (Cross Site Request Forgy)

+ 一般就是指进入一个站点 然后请求另一个站点接口
+ 常用的就是攻击者发送给用户用户点击就进行了一次攻击
+ 可以达到快速的传播 从而造成网络蠕虫的现象
+ 一般找到一个接口地址 比如一些bbs的评论发帖区域
+ **防御**
  + 可以禁止第三方网站携带 Cookies 
  + Cookies 有一个属性叫做 samesite:strict 禁止第三方网站携带Cookies 但是兼容性不好
  + 设置加入验证码
  + 加入Token
  + 可以验证请求头 referer 是否是来自自己的网站域名   req.request.header
  +  PHP中防御CSRF
  + header("Set-Cookie:test=1234; SameSite=strict")
  + $_SERVER['HTTP_REFERER']; //获取到referer

## 前端Cookies问题

#### 前端数据存储

+ 可能会被篡改
+ node  crypto 生成签名
+ ![1546959167957](E:\备份内容\笔记\1546959167957.png)

+ 从缓存中读取数据不会看到Cookie

+ Xss可能会偷取Cookie 可以禁止js偷取Cookie

+ Secure属性：

  当设置为true时，表示创建的 Cookie 会被以安全的形式向服务器传输，也就是只能在 HTTPS 连接中被浏览器传递到服务器端进行会话验证，如果是 HTTP 连接则不会传递该信息，所以不会被窃取到Cookie 的具体内容。

  HttpOnly属性：

  如果在Cookie中设置了"HttpOnly"属性，那么通过程序(JS脚本、Applet等)将无法读取到Cookie信息，这样能有效的防止XSS攻击。

## 点击劫持

+ 将目标网站作为一个iframe嵌入到攻击者网站中
+ 然后iframe设置透明度
+ 引导用户点击执行一些操作
+ 防御
  + Javascript禁止内嵌   但是iframe在h5中有一个属性sandbox=“allow-forms”  可以表单提交 禁用javascript
  + 更好的办法
    + 设置头  X-Frame-Options,DENY   禁止所有   | SAMEORIGIN 同域名允许 

## 传输安全

#### HTTP传输窃听  传输篡改

#####特征

- 支持https明文代理
- 支持低网速模拟
- 支持二次开发，可以用javascript控制代理的全部流程，搭建前端个性化调试环境
- 提供web版界面，观测请求情况
- tracert IP  可以跟踪这个网站的数据传输回环  以及IP

+ anyProxy  代理服务器
  + 安装Nodejs
  + `npm install -g anyproxy`，有可能需要`sudo`
  + python可选安装
  + 默认启动anyproxy
    定制启动端口  anyproxy --port 8001
    使用某个规则文件anyproxy --rule ./rule_sample/rule_allow_CORS.js
  + switchyomega  谷歌浏览器代理插件
  + 访问[http://127.0.0.1:8002](http://127.0.0.1:8002/)，你会在浏览器里看到实时的请求。  GUI 界面

#####解决方案

+ 使用tsl(ssl)证书 也就是https协议
+ 这样别人在监听的时候只会看到一个CONNECT的请求信息 不会看到别的
+ 证书需要申请
+ 证书一般来说有两个crt文件 和一个私钥
+ 用来与和服务器进行验证 以区别身份
+ 一个域名一个服务器对应一个证书 在请求的时候会去判断是否是当前证书对应的域名

## 密码安全

####关于后端和接入层的安全问题

+ 一定不能够明文存储
+ 一定不能够明文传输
+ 前端密文传输但是在后端需要加盐在存储到数据库 可以在前端进行加密然后在随机生成四个字符拼接到后面到后端在截去后四位字母存储到数据库达到障眼法的效果
  + 因为在前端加密直接存储到数据库就相当于这还是一个明文的密文
+ 使用https协议

## 接入层注入问题

#### sql注入防御

+ 检测数据类型
+ 使用占位符传输参数
+ 进行敏感词汇转义
+ 使用orm对象映射

#### NoSql注入防御

+ 检测数据类型
+ 类型转换
+ 写完整条件

#### 在PHP中最好不要使用mysql的扩展了可以去使用框架 或者PDO的参数化查询

## 上传问题

+ 再上传文件的时候 上传者上传完毕 然后访问这个文件可能这个文件就会当做成一个程序

#### 上传文件的防御

+ 禁止上传敏感后缀文件 例如 .php  .js
+ 文件类型的检查
+ 文件内容检查 根据文件头
+ 程序输出 通过程序输出  性能会有影响  请求某一个路径设置头信息为普通文本

## 社会工程学

#### 信息泄露

+ 泄露敏感信息
+ 泄露用户信息
+ 泄露用户密码

#### 介绍

+ 就是去挖掘互联网上的用户信息
+ 个人资料  电话号 姓名 邮箱等.....
+ 伪装公检法

#### 案例

+ 电信诈骗

#### 办法

+ oAuth思想  防止资料泄露
  + 可以使用第三方登录
    + 一切有用户授权

![1547138824067](E:\备份内容\笔记\1547138824067.png)

+ 通过accessToken获取用户信息 标识会过期 安全

## DOS AND DDOS攻击

#### DOS攻击

+ TCP 半链接    有三次握手 但是只完成一般 使服务器处于等待状态
+ HTTP链接
+ 攻击 DNS  容易攻击下来

#### DDOS 大规模分布式攻击

+ 流量可以达到几十G几百G
+ 分布式 (肉鸡[就是被黑客已经植入了一些程序的机器，或者带木马的]，代理)   
+ 来自世界各地  
+ 极难防御
+ 如果攻击规模巨大 可能运营商会给你的DNS机器停机 等待攻击结束 在开机

#### 原理

+ 发起大规模请求  造成流量过多 带宽爆满  服务崩溃

#### 有限防御

+ 防火墙
+ 交换机 路由器
+ 流量清洗
+ 商业服务  高防IP  背后有大量的流量清洗操作  
+ 一般只有云服务提供商才有这么大的带宽 提供一种这样的高防ip服务

#### DOS攻击预防

+ 避免重逻辑业务   减轻 服务器负载
+ 接触用户的服务器 与 重逻辑业务服务器分开处理
+ 快速失败 快速返回
+ 防雪崩机制
+ 有损服务  尽量避免 一个服务失败 所有服务失败
+ CDN

## 重放攻击

+ 请求被窃听或者记录
+ 再次发生相同的请求
+ 用户被多次消费

#### 防御

+ 避免数据被抓住 使用https加密  
+ 时间戳
+ token  请求过去生成一个保存起来 再次请求再次生成 保存  比如抽奖 支付功能~ 必须重视
+ nonce
+ 签名

## 暴力破解攻击

#### 检测方式

+ 远程通讯法
  + 确立攻击目标 凡是输入账号密码的地方都可以
  + 建立socket通信  为提高效率 通常是多线程
  + 输入正确的账号根据实际可对账号进行暴力枚举
  + 通过字典档或者规则生成的待测试的密码
  + 发送密码  取得验证反馈
  + 拒绝密码 重复第四步起 如果密码通过 程序停止 显示密码

## Burp Sutie 暴力破解工具

#### 介绍

+ 这款工具是基于java的必须安装java环境

